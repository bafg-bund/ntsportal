{
  "$schema": "https://vega.github.io/schema/vega/v5.json",
   "width" : 700,
   "height": 400,

  "scales": [
    {
      "name": "x",
      "type": "time",
      "range": "width",
      "domain": {
        "data": "timeseries",
        "field": "key"
      }
    },
    {
      "name": "y",
      "type": "linear",
      "range": "height",
      "domain": {
        "data": "timeseries",
        "field": "area.value"
      }
    }
  ],
  "axes": [
    {
      "orient": "bottom",
      "scale": "x"
    },
    {
      "orient": "left",
      "scale": "y"
    }
  ],
  "marks": [
    {
      "type": "area",
      "from": {
        "data": "timeseries"
      },
      "encode": {
        "update": {
          "x": {
            "scale": "x",
            "field": "key"
          },
          "y":{
            "scale": "y",
            "value": 0
          },
          "y2":{
            "scale": "y",
            "field": "area.value"
          }
        } 
      }
    },
    {
      "name": "point",
      "type": "symbol",
      "style": ["point"],
      "from": {"data": "timeseries"},
      "encode": {
        "update":{
          "x":{
            "scale": "x", "field": "key"
          },
          "y":{
            "scale": "y", "field":"area.value"
          },
          "size":{"value": 100},
          "fill":{"value":"black"}
        }
      }
    },
    {
      "type": "text",
      "encode": {
        "enter": {
          "align": {"value": "center"},
          "baseline": {"value": "bottom"},
          "fill": {"value": "#333"}
        },
        "update": {
          "x": {"scale": "x", "signal": "tooltip.key"},
          "y": {"scale": "y", "signal": "tooltip.area.value", "offset": -5},
          "text": {"signal": "tooltip.key_as_string"},
          "fillOpacity": [
            {"test": "datum === tooltip", "value": 0},
            {"value": 1}
          ]
        }
      }
    },
    {
      "type": "rule",
      "interactive": false,
      "encode": {
        "update": {
          "y":{"value": 0},
          "y2":{"signal": "height"},
          "stroke": {"value": "grey"},
          "strokeDash":{"value": [2,1]},
          "x":{"signal": "max(currentX,0)"},
          "defined":{"signal": "currentX > 0"}
        }
      }
    },
    {
      "type": "rect",
      "name": "selectedRect",
      "encode": {
        "update": {
          "height":{"signal": "height"},
          "fill":{"value": "#333"},
          "fillOpacity":{"value": 0.2},
          "x":{"signal": "selected[0]"},
          "x2":{"signal": "selected[1]"},
          "defined":{"signal": "selected[0] !== selected[1]"}
        }
      }
    }
  ],
  "signals": [
    {
      "name": "tooltip",
      "value": {},
      "on": [
        {"events": "symbol:pointerover", "update": "datum"},
        {"events": "symbol:pointerout",  "update": "{}"}
      ]
    },
    {
      "name": "currentX",
      "value": -1,
      "on": [
        {
          "events": {
            "type": "mousemove",
            "source": "view"
          },
          "update": "clamp(x(), 0, width)"
        },
        {
          "events" :{
            "type": "mouseout",
            "source": "view"
          },
          "update": "-1"
        }
      ]
    },
    {
      "name": "selected",
      "value": [0,0],
      "on": [
        {
          "events":{
            "type": "mousedown",
            "source": "view"
          },
          "update": "[clamp(x(), 0, width), clamp(x(), 0, width)]"
        },
        {
          "events":{
            "type": "mousemove",
            "source": "window",
            "consume": true,
            "between": [
              {"type": "mousedown", "source": "view"},
              {
                "merge": [
                {"type": "mouseup", "source": "window"},
                {
                  "type": "keydown", 
                  "source": "window", 
                  "filter": "event.key === 'Escape'"
                }]
              }
            ]
          },
          "update": "[selected[0], clamp(x(), 0, width)]"
        },
        {
          "events" :{
            "type": "keydown",
            "source": "window",
            "filter": "event.key === 'Escape'"
          },
          "update": "[0,0]"
        }
      ]
    }
  ],
  "data": [{
    "name": "timeseries",
    "format": {"property": "aggregations.ts.buckets"},
    "values": {
  "took": 2,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": {
      "value": 83,
      "relation": "eq"
    },
    "max_score": null,
    "hits": []
  },
  "aggregations": {
    "ts": {
      "buckets": [
        {
          "key_as_string": "2008-01-01 00:00:00",
          "key": 1199145600000,
          "doc_count": 5,
          "area": {
            "value": 106.4
          }
        },
        {
          "key_as_string": "2009-01-01 00:00:00",
          "key": 1230768000000,
          "doc_count": 6,
          "area": {
            "value": 253.5
          }
        },
        {
          "key_as_string": "2010-01-01 00:00:00",
          "key": 1262304000000,
          "doc_count": 6,
          "area": {
            "value": 319.6666666666667
          }
        },
        {
          "key_as_string": "2011-01-01 00:00:00",
          "key": 1293840000000,
          "doc_count": 6,
          "area": {
            "value": 467
          }
        },
        {
          "key_as_string": "2012-01-01 00:00:00",
          "key": 1325376000000,
          "doc_count": 6,
          "area": {
            "value": 841
          }
        },
        {
          "key_as_string": "2013-01-01 00:00:00",
          "key": 1356998400000,
          "doc_count": 6,
          "area": {
            "value": 778.1666666666666
          }
        },
        {
          "key_as_string": "2014-01-01 00:00:00",
          "key": 1388534400000,
          "doc_count": 6,
          "area": {
            "value": 1126
          }
        },
        {
          "key_as_string": "2015-01-01 00:00:00",
          "key": 1420070400000,
          "doc_count": 6,
          "area": {
            "value": 1112.6666666666667
          }
        },
        {
          "key_as_string": "2016-01-01 00:00:00",
          "key": 1451606400000,
          "doc_count": 6,
          "area": {
            "value": 1615.8333333333333
          }
        },
        {
          "key_as_string": "2017-01-01 00:00:00",
          "key": 1483228800000,
          "doc_count": 6,
          "area": {
            "value": 1665.6666666666667
          }
        },
        {
          "key_as_string": "2018-01-01 00:00:00",
          "key": 1514764800000,
          "doc_count": 6,
          "area": {
            "value": 2023.3333333333333
          }
        },
        {
          "key_as_string": "2019-01-01 00:00:00",
          "key": 1546300800000,
          "doc_count": 6,
          "area": {
            "value": 1970.6666666666667
          }
        },
        {
          "key_as_string": "2020-01-01 00:00:00",
          "key": 1577836800000,
          "doc_count": 6,
          "area": {
            "value": 987.1666666666666
          }
        },
        {
          "key_as_string": "2021-01-01 00:00:00",
          "key": 1609459200000,
          "doc_count": 6,
          "area": {
            "value": 1502.6666666666667
          }
        }
      ]
    }
  }
}
  }]
}