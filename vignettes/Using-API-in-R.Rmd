---
title: "Using the NTSPortal Elasticsearch Search API in R"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using the NTSPortal Elasticsearch Search API in R}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# API Connection, getting started

The API is called from `elastic.bafg.de`. Users must 1) have been granted API access (please send a request to `ntsportal@bafg.de`) and 2) must have created an API key for themselves at `ntsportal.bafg.de` (Menu->Management->Stack Management->Security->API keys)

The API documentation is found [here](https://www.elastic.co/docs/api/doc/elasticsearch/). Detailed documentation is available for the different search languages offered, e.g. [Query DSL](https://www.elastic.co/docs/reference/query-languages/querydsl) or [ES|QL](https://www.elastic.co/docs/reference/query-languages/esql). 

# Introduction

The R-package *elastic* allows calls to the ElasticSearch API from within R and the json data is returned as a `list` or a `data.frame`. The list can then be reformatted as a `data.frame` for analysis in R. The best way to get started is to test your query in the kibana dev tools console and then copy the query, as text, into R and run the command from there. Since *elastic* is no longer maintained, the preferred option is to use the Python *elasticsearch* or *elasticsearch-dsl* modules from within R using *reticulate*. The `PythonDbComm` class uses this.

# Connect using R

## Example using a config.yml

Depending on the security settings, the username and password may be sufficient to connect to the elasticsearch API. Alternatively, an API Key may be needed.

`config.yml` holds the username and password in the form:

```yaml
default:
  elastic_connect:
    user: 'XXXXXXXX'
    pwd:  'XXXXXXXX'

```

```{r, eval=FALSE}
config_path <- "~/config.yml"

ec <- config::get("elastic_connect", file = config_path)

escon <- elastic::connect(
  host = 'xxxxx.bafg.de', 
  port = XXX, user=ec$user, 
  pwd  = ec$pwd,
  transport_schema = "https"
)

if (escon$ping()$cluster_name != "bfg-elastic-cluster") {
  stop("Connection to es-db not established")
}

rm(config_path)
rm(ec)

logger::log_info("Connection to ntsp successful")
```

This code can be saved in a script e.g. `connect-ntsp.R` and run in any R-script with `source("~/connect-ntsp.R")` thereby producing the `elastic::connect` variable `escon`

## Ignoring SSL verification

If there is a certificate error, you can turn off SSL verification:

```{r, eval=FALSE}
escon <- elastic::connect(
  host = 'xxxx.bafg.de', 
  port = XXX, user=ec$user, 
  pwd  = ec$pwd,
  transport_schema = "https",
  ssl_verifypeer = F
)
```

## Check your IP

To check the IP from which you are trying to connect:

```{r, eval=FALSE}
library(rjson)
fromJSON(readLines("http://api.hostip.info/get_json.php", warn=F))$ip
```

# Examples
## Getting a data.frame with chosen fields for a simple query
In this example, we are retrieving all the documents from the measurement station "mosel_ko_r" (Moselle, Koblenz, right bank).

Using the dev tools console, we make the following request:
```json
GET ntsp_dbas*/_search
{
  "query": {
    "term": {
      "station": {
        "value": "mosel_ko_r"
      }
    }
  },
  "_source": ["name", "inchikey", "pol", "start", "duration", 
              "area", "area_is", "area_normalized"]
}
```
Response:
```json
{
  "took": 15,
  "timed_out": false,
  "_shards": {
    "total": 15,
    "successful": 15,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": {
      "value": 10000,
      "relation": "gte"
    },
    "max_score": 0.71082175,
    "hits": [
      {
        "_index": "g2_dbas_v231229_expn",
        "_id": "6krzxIwB6C8k9zJxN0cV",
        "_score": 0.71082175,
        "_source": {
          "name": "Oleamide",
          "area": 50,
          "area_is": 1770,
          "area_normalized": 0.0283,
          "start": "2021-05-26",
          "duration": 1,
          "pol": "pos"
        }
      },
      {
        "_index": "g2_dbas_v231229_expn",
      ...
``` 
The response shows that the total number of hits is greater than or equal to (gte) 10000 (max documents reached). Therefore, we can not retrieve all documents with one request and must [paginate search results](https://www.elastic.co/guide/en/elasticsearch/reference/current/paginate-search-results.html).

The function `ntsportal::esSearchPaged` works similarly to `elastic::Search` but will paginate the results.

```{r, eval=FALSE}
connectNtsportal()
res <- esSearchPaged("ntsp25.1_dbas*", searchBody = list(query = list(term = list(station = "mosel_ko_r"))), 
   source = c("name", "inchikey", "pol", "start", "duration", "area"), sort = "mz")
 
# Convert the returned list to a data.frame
temp <- lapply(res$hits$hits, function(x) as.data.frame(x[["_source"]]))
df <- plyr::rbind.fill(temp)
```

