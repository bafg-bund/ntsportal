<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Add new records for MS measurement files to msrawfiles index — addRawfiles • ntsportal</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Inter-0.4.10/font.css" rel="stylesheet"><link href="../deps/JetBrains_Mono-0.4.10/font.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet"><meta property="og:title" content="Add new records for MS measurement files to msrawfiles index — addRawfiles"><meta name="description" content="Add new records for MS measurement files to msrawfiles index"><meta property="og:description" content="Add new records for MS measurement files to msrawfiles index"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ntsportal</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">25.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><h6 class="dropdown-header" data-toc-skip>Front end UI</h6></li>
    <li><a class="dropdown-item" href="../articles/using-ntsportal-front-end.html">Using ntsportal.bafg.de</a></li>
    <li><a class="dropdown-item" href="../articles/Kurzanleitung-zur-ersten-Nutzung.html">Kurzanleitung zur ersten Nutzung</a></li>
    <li><a class="dropdown-item" href="../articles/Dashboard-development.html">Dashboard development</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Using the Search API</h6></li>
    <li><a class="dropdown-item" href="../articles/Searching-with-ElasticSearch-Query-DSL.html">Searching with Query DSL</a></li>
    <li><a class="dropdown-item" href="../articles/Aggregations-with-ElasticSearch-Query-DSL.html">Aggregations with Query DSL</a></li>
    <li><a class="dropdown-item" href="../articles/Connecting-to-NTSPortal-API.html">Using the Search API in R</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Database structure and algorithms</h6></li>
    <li><a class="dropdown-item" href="../articles/Structure-of-NTSPortal.html">Structure of NTSPortal</a></li>
    <li><a class="dropdown-item" href="../articles/Library-screening.html">Library Screening</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Database management</h6></li>
    <li><a class="dropdown-item" href="../articles/Add-measurement-file-to-msrawfiles.html">Adding measurement files to msrawfiles</a></li>
    <li><a class="dropdown-item" href="../articles/Modify-documents-using-API.html">Modifying documents via the API</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Naming conventions</h6></li>
    <li><a class="dropdown-item" href="../articles/Station-naming.html">Station naming</a></li>
    <li><a class="dropdown-item" href="../articles/Measurement-file-naming-conventions.html">Measurement file naming</a></li>
    <li><a class="dropdown-item" href="../articles/Chromatographic-methods.html">Chromatographic methods naming</a></li>
  </ul></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><a class="external-link nav-link" href="https://www.bafg.de" aria-label="BfG Website">BfG</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/bafg-bund/ntsportal" aria-label="View source code on github.com"><span class="fa fa-github"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Add new records for MS measurement files to msrawfiles index</h1>
      <small class="dont-index">Source: <a href="https://github.com/bafg-bund/ntsportal/blob/HEAD/R/msrawfiles-addRecord.R" class="external-link"><code>R/msrawfiles-addRecord.R</code></a></small>
      <div class="d-none name"><code>addRawfiles.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Add new records for MS measurement files to msrawfiles index</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">addRawfiles</span><span class="op">(</span></span>
<span>  <span class="va">rfIndex</span>,</span>
<span>  <span class="va">templateId</span>,</span>
<span>  <span class="va">newPaths</span>,</span>
<span>  newStart <span class="op">=</span> <span class="st">"filename"</span>,</span>
<span>  newStation <span class="op">=</span> <span class="st">"same_as_template"</span>,</span>
<span>  dirMeasurmentFiles <span class="op">=</span> <span class="st">"/srv/cifs-mounts/g2/G/G2/HRMS/Messdaten/"</span>,</span>
<span>  promptBeforeIngest <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  saveDirectory <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  newStationList <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>station <span class="op">=</span> <span class="st">"example_new_station"</span>, loc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lat <span class="op">=</span> <span class="fl">1.23456</span>, lon <span class="op">=</span></span>
<span>    <span class="fl">1.23456</span><span class="op">)</span>, river <span class="op">=</span> <span class="st">"example_new_river"</span>, gkz <span class="op">=</span> <span class="fl">99999</span>, km <span class="op">=</span> <span class="fl">99999</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-templateid">templateId<a class="anchor" aria-label="anchor" href="#arg-templateid"></a></dt>
<dd><p>ES-ID for an existing msrawfiles-record to use as a template</p></dd>


<dt id="arg-newpaths">newPaths<a class="anchor" aria-label="anchor" href="#arg-newpaths"></a></dt>
<dd><p>Character vector of full paths to new rawfiles which are to be added, must be mzXML files.</p></dd>


<dt id="arg-newstart">newStart<a class="anchor" aria-label="anchor" href="#arg-newstart"></a></dt>
<dd><p>Either "filename" (default), meaning extract the start time from the filename or provide a start date
as an 8 digit number "YYYYMMDD"</p></dd>


<dt id="arg-newstation">newStation<a class="anchor" aria-label="anchor" href="#arg-newstation"></a></dt>
<dd><p>Either be "same_as_template" (default), which will copy the value from the template document, or
"filename", meaning extract the station and loc values from the code in the filename (will compare to other docs in
msrawfiles index) or "newStationList" to add a new station. See details.</p></dd>


<dt id="arg-dirmeasurmentfiles">dirMeasurmentFiles<a class="anchor" aria-label="anchor" href="#arg-dirmeasurmentfiles"></a></dt>
<dd><p>Root directory where original measurement files are located. The function will look for original
(vendor) files in this directory or below. Must end with "/".</p></dd>


<dt id="arg-promptbeforeingest">promptBeforeIngest<a class="anchor" aria-label="anchor" href="#arg-promptbeforeingest"></a></dt>
<dd><p>Should the user be asked to verify the submission? (Default: TRUE). A file called
"add-rawfiles-check.json" created in the saveDirectory which the user can check and make changes to. See details
"making manual changes".</p></dd>


<dt id="arg-savedirectory">saveDirectory<a class="anchor" aria-label="anchor" href="#arg-savedirectory"></a></dt>
<dd><p>Location to save temporary json file for checking and making manual changes. (defaults to
current working dir)</p></dd>


<dt id="arg-newstationlist">newStationList<a class="anchor" aria-label="anchor" href="#arg-newstationlist"></a></dt>
<dd><p>List with fields "station" and "loc" and optionally "river", "gkz" and "km" to add a new
station. see details</p></dd>


<dt id="arg-rfindex">rfindex<a class="anchor" aria-label="anchor" href="#arg-rfindex"></a></dt>
<dd><p>index name for rawfiles index</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>Returns vector of new ES-IDs of the generated and imported documents</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p><strong>Adding location information (`station` and `loc` fields)</strong>
  newStation can be either "same_as_template", "filename" or "newStationList".</p>
<p>Using "same_as_template" means the station and location information is copied from the template</p>
<p>Using "filename" means it will use the `dbas_station_regex` field in the index to get the station information from
  another record in the index. The function will use the regex to extract the station code from the filename and
  search the msrawfiles index for other records with this station code. If an unambiguous location is found, it will
  gather all available location information and use this for the new record entry. This option is useful if the batch
  that is being added contains more than one station.</p>
<p>Using "newStationList" means a new fixed station name and location is passed (use list in the argument
  "newStationList" with fields "station" and "loc" and optionally "river", "gkz" and "km") "loc" being a geopoint
  with fields "lat" and "lon". Station and river names should all be lowercase with no spaces and no special
  characters. For the station name use the convention &lt;river_town_position&gt; where position is l, r or m for left,
  right, middle. If there is no obvious town but km is known, then use the convention &lt;river&gt;_&lt;km&gt; for the station
  name. If neither town nor km is known, use the convention &lt;river&gt;_&lt;description&gt; where description is some
  indication of the location.</p>
<p><strong>Adding sample time information (`start` field)</strong></p>
<p>Using "filename" means that the sample time is extracted from the filename. The field `dbas_date_regex` is used to
  find the date of the sample from the file name. It works in conjunction with `dbas_date_format`. `dbas_date_regex`
  extracts the text, while `dbas_date_format` tells R how to interpret the text. For example, the file name
  `RH_pos_20170101.mzXML` uses the date_regex `"([20]*\d6)"` and date_format `"ymd"`. The `dbas_date_regex` uses
  the tidyverse regular expression syntax and the `stringr::str_match` function to extract the text referring to the
  date. The brackets indicate the text to extract and these can be surrounded by anchors. It is also possible to have
  multiple brackets, the text in multiple brackets will be combined before parsing. For example the file
  `UEBMS_2024_002_Main_Kahl_Jan_pos_DDA.mzXML` can be parsed with date_regex `_(20\d2)_.*_(\w3)_pos` and
  date_format `ym`.</p>
<p>`dbas_date_format` may be one of `"ymd"`, `"dmy"`, `"ym"` for year-month and `"yy"` for just the year. The date
  parsing is done by `lubridate`.</p>
<p><strong>Making manual changes</strong></p>
<p>Manual changes can be made to the json but only if one document is added (this is to minimize errors). Select "c"
  at the promt (after changes to the json have been saved).</p>
<p><strong>File storage locations</strong></p>
<p>The location of where the mzXML files are stored is given in the argument `newPaths`.`saveDirectory` is where the json
  file is written to. `dirMeasurmentFiles` is only used to look for the original (non-converted) vendor files (e.g.,
  wiff files) to read the measurement time (which is not copied into the mzXML file using some converters). Depending
  on the number of files being uploaded, the function can be very slow because the function will look through a large
  directory. To improve performance, you can tell the function to look in a smaller directory. If no files are found
  then the function will add the creation time of the mzXML file.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bafg-bund/ntsportal" class="external-link">ntsportal</a></span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="connectNtsportal.html">connectNtsportal</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">rfindex</span> <span class="op">&lt;-</span> <span class="st">"ntsp_msrawfiles"</span></span></span>
<span class="r-in"><span><span class="va">paths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="st">"/beegfs/nts/ntsportal/msrawfiles/ulm/schwebstoff/dou_pos/"</span>, <span class="st">"^Ulm.*mzXML$"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">templateId</span> <span class="op">&lt;-</span> <span class="fu"><a href="findTemplateId.html">findTemplateId</a></span><span class="op">(</span><span class="va">rfindex</span>, blank <span class="op">=</span> <span class="cn">FALSE</span>, pol <span class="op">=</span> <span class="st">"pos"</span>, station <span class="op">=</span> <span class="st">"donau_ul_m"</span>, matrix <span class="op">=</span> <span class="st">"spm"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">addRawfiles</span><span class="op">(</span>rfindex <span class="op">=</span> <span class="va">rfindex</span>, templateId <span class="op">=</span> <span class="va">templateId</span>, newPaths <span class="op">=</span> <span class="va">paths</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="checkMsrawfiles.html">checkMsrawfiles</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Files in batch have different sample location</span></span></span>
<span class="r-in"><span><span class="fu">addRawfiles</span><span class="op">(</span><span class="va">rfindex</span>, <span class="st">"eIRBnYkBcjCrX8D7v4H5"</span>, <span class="va">newFiles</span><span class="op">[</span><span class="fl">4</span><span class="op">:</span><span class="fl">17</span><span class="op">]</span>, newStation <span class="op">=</span> <span class="st">"filename"</span>, </span></span>
<span class="r-in"><span>dirMeasurmentFiles <span class="op">=</span> <span class="st">"~/messdaten/sachsen/"</span><span class="op">)</span> </span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Addition of a new station</span></span></span>
<span class="r-in"><span><span class="fu">addRawfiles</span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">rfindex</span>, <span class="st">"eIRBnYkBcjCrX8D7v4H5"</span>, <span class="va">newFiles</span><span class="op">[</span><span class="fl">15</span><span class="op">]</span>, </span></span>
<span class="r-in"><span>  newStation <span class="op">=</span> <span class="st">"newStationList"</span>,</span></span>
<span class="r-in"><span>  newStationList <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    station <span class="op">=</span> <span class="st">"pleisse_9"</span>,</span></span>
<span class="r-in"><span>    loc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lat <span class="op">=</span> <span class="fl">51.251489</span>, lon <span class="op">=</span> <span class="fl">12.383758</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    river <span class="op">=</span> <span class="st">"pleisse"</span>,</span></span>
<span class="r-in"><span>    km <span class="op">=</span> <span class="fl">9</span>,</span></span>
<span class="r-in"><span>    gkz <span class="op">=</span> <span class="fl">5666</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span> </span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Developed by Kevin S. Jewell, Ole Lessmann.</p>
</div>

    </footer></div>





  </body></html>

